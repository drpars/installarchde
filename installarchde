#!/bin/bash

# ==========================================================
# Arch Linux DE & Apps Kurulum ve Konfigürasyon Betiği
# Bu betik, dialog menülerini kullanarak sürücüleri, uygulama
# paketlerini, Masaüstü Ortamlarını ve system ayarlarını
# interaktif olarak kurup yapılandırmak için tasarlanmıştır.
# ==========================================================

# --------------------------
# Gerekli Fonksiyonlar
# --------------------------

# Kullanıcıya onay sorusu sorar. Geri dönüş kodu 0 ise Evet, 1 ise Hayır.
confirm() {
  local prompt="$1"
  local title="${2:-Onay}"
  local height="${3:-0}"
  local width="${4:-0}"

  dialog --backtitle "$apptitle" --title "$title" --yesno "$prompt" "$height" "$width"
  return $?
}

message() {
  local text="$1"
  local title="${2:-Mesaj}"
  local height="${3:-0}"
  local width="${4:-0}"

  dialog --backtitle "$apptitle" --title "$title" --msgbox "$text" "$height" "$width"
}

# CPU modelini kontrol eder.
cpumodel() {
  local query="$1"

  if grep -qi "$query" /proc/cpuinfo; then
    return 0
  else
    return 1
  fi
}

# GPU modelini kontrol eder.
gpumodel() {
  local query="$1"
  if lspci | grep -Ei "VGA|3D" | grep -qi "$query"; then
    return 0
  else
    return 1
  fi
}

# Kullanıcı girişini bekler.
pressanykey() {
  read -n1 -r -p "Devam etmek için bir tuşa basın..."
  echo
}

# Global değişkenleri temizler.
resetvalue() {
  for arg; do
    unset ${arg}
  done
}

# Packet yükleme fonksiyonu (Pacman ve AUR)
instpkg() {
  clear
  # pkg: Pacman'den yüklenecek paketler
  # aurpkg: AUR'dan (yay/paru) yüklenecek paketler
  pkg="$1"
  aurpkg="$2"

  if [[ -n "$pkg" ]]; then
    echo "# sudo pacman -S --needed $pkg"
    sudo pacman -S --needed $pkg
    pressanykey
  fi

  if [[ -n "$aurpkg" ]]; then
    local aurhelper
    if command -v yay &>/dev/null; then
      aurhelper="yay"
    elif command -v paru &>/dev/null; then
      aurhelper="paru"
    else
      echo "AUR paketlerini kurmak için bir AUR yardımcısı (yay veya paru) Kurulum/Güncelleme menüsünden yüklenmelidir!"
      return 1
    fi

    echo "# sudo -u $localuser $aurhelper -S --needed $aurpkg"
    sudo -u $localuser $aurhelper -S --needed $aurpkg
    pressanykey
  fi

  resetvalue pkg aurpkg
}

# İnteraktif packet seçme fonksiyonu (Pacman depolarından arama yapar)
choosepkg() {
  local search_term="$1"
  local title="${2:-$1}"
  local options=()
  local items

  items=$(pacman -Ssq "$search_term")

  for item in $items; do
    options+=("$item" "" off)
  done

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "$title" --cancel-button "Back" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -ne 0 ]]; then
    return 1
  fi

  local pkg=""
  for itm in $sel; do
    pkg="$pkg $(echo "$itm" | sed 's/"//g')"
  done

  instpkg "$pkg" "$aurpkg"
  return 0
}

# Systemd servisini etkinleştirir
serviceenable() {
  local service_name="$1"
  local display_name="${2:-$1}" # Use $1 if $2 is not provided

  if confirm "Önyüklemede $display_name servisini başlatmak istiyor musunuz?\n\nsystemctl enable $service_name"; then
    clear
    echo "sudo systemctl enable $service_name"
    sudo systemctl enable "$service_name"
    pressanykey
  fi
}

# Systemd servisini devre dışı bırakır
servicedisable() {
  local service_name="$1"
  local display_name="${2:-$1}" # Use $1 if $2 is not provided

  if confirm "Önyüklemede $display_name servisini devre dışı bırakmak istiyor musunuz?\n\nsystemctl disable $service_name"; then
    clear
    echo "sudo systemctl disable $service_name"
    sudo systemctl disable "$service_name"
    pressanykey
  fi
}

# Tek bir dosya/dizin için sembolik bağ (symlink) oluşturur
symlink_sync() {
  local anysource="$1"
  local anytarget="$2"

  # Resolve absolute paths
  local abs_source=$(realpath -e "$anysource")
  local abs_target_parent=$(dirname "$(realpath -m "$anytarget")")

  mkdir -p "$abs_target_parent"
  local relative_path=$(realpath --relative-to="$abs_target_parent" "$abs_source")
  ln -svfn "$relative_path" "$anytarget"
}

# Bir dizindeki tüm öğeler için özyinelemeli sembolik bağ oluşturur
symlink_sync_recursive() {
  local source_root="$1"
  local target_root="$2"

  while IFS= read -r -d $'\0' item; do
    local relative_path="${item#$source_root/}"
    symlink_sync "$item" "$target_root/$relative_path"
  done < <(find "$source_root" -mindepth 1 -print0)
}

# Git deposu klonlama fonksiyonu
clone_repo() {
  local repo_name="$1"
  local target_dir="${2:-$script_dir/$repo_name}"
  local repo_url="https://github.com/drpars/$repo_name.git"
  local max_retries=3
  local retry_count=0

  clear

  if [[ -z "$repo_name" ]]; then
    echo "Hata: Depo adı belirtilmedi!" >&2
    pressanykey
    return 1
  fi

  if [[ ! "$repo_name" =~ ^[a-zA-Z0-9_.-]+$ ]]; then
    echo "Hata: Geçersiz depo adı formatı!" >&2
    echo "Sadece harf, rakam ve ._- karakterlerine izin verilir." >&2
    pressanykey
    return 1
  fi

  echo -e "\033[1;36m┌─────────────────────────────────────────────────────────────┐\033[0m"
  echo -e "\033[1;36m│󰄬  Depo: \033[1;33m$repo_name\033[0m"
  echo -e "\033[1;36m├─────────────────────────────────────────────────────────────┤\033[0m"
  echo -e "\033[1;36m│  Hedef: \033[0;34m$target_dir\033[0m"
  echo -e "\033[1;36m└─────────────────────────────────────────────────────────────┘\033[0m"
  echo

  clear
  if [[ -e "$target_dir" ]]; then
    if [[ "$(realpath "$target_dir")" == "$(realpath "$script_dir")" ]]; then
      echo -e "\033[1;31m Kritik Hata: Betiğin kendi dizinine klonlama yapılamaz!\033[0m"
      pressanykey
      return 1
    fi

    if [[ -d "$target_dir/.git" ]]; then
      echo -e "\033[1;33m Depo zaten var: $target_dir\033[0m"
      echo -e "Uzak URL: $(git -C "$target_dir" config --get remote.origin.url)"

      if confirm "Depoyu yeniden klonla? (Mevcut dosyaların üzerine yazılacak)" "no" 12 60; then
        clear
        echo -e "\033[1;36m Dizin temizleniyor...\033[0m"
        if ! rm -rf "${target_dir:?}"; then
          echo -e "\033[1;31m Dizin temizlenemedi!\033[0m"
          pressanykey
          return 1
        fi
      else
        clear
        echo -e "\033[1;36m Mevcut depo kullanılıyor\033[0m"
        pressanykey
        return 0 # Continue with existing repo
      fi
    else
      echo -e "\033[1;33m Dizin var ancak git deposu değil: $target_dir\033[0m"
      if confirm "Overwrite directory?" "no" 12 60; then
        clear
        echo -e "\033[1;36m Dizin temizleniyor...\033[0m"
        if ! rm -rf "${target_dir:?}"; then
          echo -e "\033[1;31m Dizin temizlenemedi!\033[0m"
          pressanykey
          return 1
        fi
      else
        clear
        echo -e "\033[1;36m Klonlama işlemi atlanıyor\033[0m"
        pressanykey
        return 0
      fi
    fi
  fi

  while ((retry_count < max_retries)); do
    echo -e "\033[1;36m Depo klonlanıyor (Deneme $((retry_count + 1))/$max_retries)...\033[0m"

    if git clone --progress --depth 1 "$repo_url" "$target_dir"; then
      echo -e "\n\033[1;32m Başarıyla klonlandı: $target_dir\033[0m"
      echo -e "\033[1;36m Dizin yapısı:\033[0m"
      command -v tree >/dev/null && tree -L 2 "$target_dir" || ls -la "$target_dir"
      pressanykey
      return 0
    else
      echo -e "\n\033[1;31m Klonlama başarısız (Deneme $((retry_count + 1))/$max_retries)\033[0m" >&2
      ((retry_count++))

      if ((retry_count < max_retries)); then
        echo -e "\033[1;33m 5 saniye sonra tekrar deneniyor...\033[0m"
        sleep 5
      else
        echo -e "\033[1;31m Kritik Hata: $max_retries denemeden sonra klonlama başarısız\033[0m" >&2
        pressanykey
        return 1
      fi
    fi
  done
}

# rsync'in kurulu olup olmadığını kontrol eder ve kurar
isrsync() {
  if ! command -v rsync &>/dev/null; then
    clear
    echo "rsync kuruluyor ..."
    instpkg "rsync" ""
    pressanykey
  fi
}

ddci-setup() {
  # =================================================================
  # DDCCI KURULUM VE SİSTEM HAZIRLIK
  # Yöntem: Manuel Tetikleme Retry Loop
  # "journalctl -xeu ddcci-backlight-retry.service" ile kurulum sonrası kontrol yapılabilir.
  # =================================================================

  # Gerekli dosya/modül adları
  DDCCI_MODULE="ddcci"
  DDCCI_BACKLIGHT_MODULE="ddcci-backlight"
  MODULES_CONF="/etc/modules-load.d/ddcci.conf"
  AUR_DRIVER="ddcci-driver-linux-dkms-git"
  RETRY_SCRIPT="/usr/local/bin/ddcci-retry-loader.sh"
  SERVICE_FILE="/etc/systemd/system/ddcci-backlight-retry.service"

  # =================================================================
  # D D C I - F O N K S İ Y O N L A R
  # =================================================================

  # 1. I2C Numarasını bulan fonksiyon
  find_i2c_number() {
    if ! command -v ddcutil &>/dev/null; then
      echo "HATA: 'ddcutil' komutu bulunamadı." >&2
      read -r -p "ddcutil paketini kurmak ister misiniz? (Arch Linux: sudo pacman -S ddcutil) [e/H] " response
      response=${response,,}
      if [[ "$response" =~ ^(e|evet)$ ]]; then
        echo "ddcutil kuruluyor..."
        if instpkg ddcutil ""; then
          echo "ddcutil başarıyla kuruldu."
        else
          echo "HATA: ddcutil kurulumu başarısız oldu." >&2
          return 1
        fi
      else
        echo "Kurulum iptal edildi." >&2
        return 1
      fi
    fi

    local I2C_NUMBER
    I2C_NUMBER=$(ddcutil detect 2>/dev/null |
      grep -E '^[[:space:]]*I2C bus:' |
      head -n 1 |
      grep -Eo '[0-9]+' |
      tail -n 1)

    if [ -z "$I2C_NUMBER" ]; then
      echo "KRİTİK HATA: DDC/CI destekleyen bir monitör bulunamadı." >&2
      return 1
    else
      echo "$I2C_NUMBER"
      return 0
    fi
  }

  # 2. AUR sürücüsünü kontrol eden ve kuran fonksiyon
  install_aur_driver() {
    if pacman -Qq "$AUR_DRIVER" &>/dev/null; then
      echo "BİLGİ: $AUR_DRIVER sürücüsü zaten kurulu."
      return 0
    fi
    echo "UYARI: $AUR_DRIVER sürücüsü kurulu değil." >&2

    read -r -p "$AUR_DRIVER sürücüsünü yay ile kurmak ister misiniz? (AUR paketi) [e/H] " response
    response=${response,,}
    if [[ "$response" =~ ^(e|evet)$ ]]; then
      echo "$AUR_DRIVER kuruluyor..."
      if instpkg "" "$AUR_DRIVER"; then
        echo "$AUR_DRIVER başarıyla kuruldu."
        return 0
      else
        echo "HATA: $AUR_DRIVER kurulumu başarısız oldu." >&2
        return 1
      fi
    else
      echo "Kurulum iptal edildi."
      return 1
    fi
  }

  # 3. Modülleri otomatik yükleme için ayarlayan fonksiyon
  setup_modules_load() {
    echo "--- Modül Yükleme Kurulumu ---"
    # Modüllerin otomatik yüklenmesi (modülün var olması şarttır)
    echo "BİLGİ: Çekirdek modüllerini kalıcı olarak yüklemek üzere $MODULES_CONF dosyasına ekleniyor."
    echo "$DDCCI_MODULE" | sudo tee "$MODULES_CONF" >/dev/null
    echo "$DDCCI_BACKLIGHT_MODULE" | sudo tee -a "$MODULES_CONF" >/dev/null
  }

  # 4. Systemd Retry Loader'ı oluşturan ve etkinleştiren fonksiyon
  create_systemd_retry_loader() {
    local I2C_NUM="$1"

    echo "--- Systemd Retry Loader Oluşturuluyor ---"

    # a) Retry Loader Script'i Oluşturuluyor
    echo "BİLGİ: Retry Loader script'i $RETRY_SCRIPT oluşturuluyor."

    cat <<EOF | sudo tee "$RETRY_SCRIPT" >/dev/null
#!/bin/bash
MAX_ATTEMPTS=7
I2C_NUM="$I2C_NUM" 
DDCCI_DEVICE="ddcci\${I2C_NUM}"

echo "[\$0] DDCCI Retry Loader başlatılıyor. I2C: \${I2C_NUM}"

# 1. Manuel Tetikleme
echo 'ddcci 0x37' > "/sys/bus/i2c/devices/i2c-\${I2C_NUM}/new_device" 2>/dev/null
  
for i in \$(seq 1 \$MAX_ATTEMPTS); do
  if [ -d "/sys/class/backlight/\$DDCCI_DEVICE" ]; then
    echo "[\$0] BAŞARILI: Cihaz \$DDCCI_DEVICE \$i. denemede bulundu."
    exit 0
  fi
  
  echo "[\$0] Deneme \$i/\$MAX_ATTEMPTS: Manuel tetikleme ve yeniden yükleme deneniyor..."

  # 2. Modüllerin Yeniden Yüklenmesi (Bu, cihazın zorla benimsediği kayıt işlemini tamamlar)
  /usr/bin/modprobe -r ddcci-backlight 2>/dev/null
  /usr/bin/modprobe -r ddcci 2>/dev/null
  /usr/bin/modprobe ddcci 
  /usr/bin/modprobe ddcci-backlight
  
  /usr/bin/sleep 1
done

echo "[\$0] KRİTİK HATA: Cihaz \$DDCCI_DEVICE \$MAX_ATTEMPTS denemeden sonra bulunamadı." >&2
exit 1
EOF

    sudo chmod +x "$RETRY_SCRIPT"

    # b) Systemd Service İçeriği
    local SERVICE_CONTENT="[Unit]
Description=DDCCI Backlight Retry Loader for i2c-N
Wants=systemd-modules-load.service local-fs.target
After=systemd-modules-load.service local-fs.target
After=display-manager.service

[Service]
Type=oneshot
User=root
ExecStart=$RETRY_SCRIPT
TimeoutSec=10 
StandardOutput=journal

[Install]
WantedBy=multi-user.target"

    echo "$SERVICE_CONTENT" | sudo tee "$SERVICE_FILE" >/dev/null

    # c) Hizmeti Etkinleştir
    echo "BİLGİ: ddcci-backlight-retry.service etkinleştiriliyor."
    sudo systemctl daemon-reload
    sudo systemctl enable ddcci-backlight-retry.service >/dev/null 2>&1

    echo "BAŞARILI: Systemd Retry Hizmeti kuruldu ve etkinleştirildi."
  }

  # 5. Anında Kontrol Fonksiyonu
  instant_check_and_trigger() {
    local I2C_NUM="$1"
    local DDCCI_DEVICE="ddcci${I2C_NUM}"

    echo "--- Anında Kontrol ve Tetikleme ---"

    echo "BİLGİ: Retry Loader hizmeti anında başlatılıyor..."
    sudo systemctl start ddcci-backlight-retry.service

    sleep 3
    if [ -d "/sys/class/backlight/$DDCCI_DEVICE" ]; then
      echo "=========================================================="
      echo "BAŞARILI! DDCCI cihazı ($DDCCI_DEVICE) anında algılandı."
      return 0
    else
      echo "KRİTİK HATA: Anında algılama başarısız oldu." >&2
      return 1
    fi
  }

  # =================================================================
  # A N A  Ç A L I Ş M A
  # =================================================================

  clear
  echo "DDCCI Kurulum Script'i Başlatılıyor ..."

  # Önceki başarısız denemelerden kalıntıları temizle
  echo "BİLGİ: Önceki systemd servisleri ve modül ayarları temizleniyor..."
  # modprobe.d dosyasını da temizleyelim
  sudo systemctl disable ddcci-backlight-retry.service 2>/dev/null
  sudo rm "$SERVICE_FILE" "$RETRY_SCRIPT" /etc/modprobe.d/ddcci.conf 2>/dev/null
  sudo systemctl daemon-reload

  # 1. Sürücüyü kontrol et/kur
  if ! install_aur_driver; then exit 1; fi

  # 2. I2C Numarasını bul
  I2C_NUM=$(find_i2c_number)
  if [ $? -ne 0 ]; then exit 1; fi

  # 3. Modüllerin yüklenmesini ayarla
  setup_modules_load "$I2C_NUM"

  # 4. Systemd Retry Loader'ı oluştur ve etkinleştir
  create_systemd_retry_loader "$I2C_NUM"

  # 5. Anında test et ve tetikle
  if instant_check_and_trigger "$I2C_NUM"; then
    echo "Kurulum tamamlandı. Cihaz anında algılandı. Systemd servisi kalıcı çözümünüzdür. Keyifli kullanımlar!"
  else
    echo "Kurulum tamamlandı. Anında algılama başarısız olsa da, **sistemin yeniden başlatılması gerekir**. Retry hizmeti açılışta denemeye devam edecektir."
  fi
  pressanykey
}

# --------------------------
# ANA MENÜLER
# --------------------------

# Ana Menüyü gösterir
mainmenu() {
  local nextitem="${1:-.}"
  local options=(
    "Güncelleme" "Sistem ve AUR güncellemeleri ile ilgili araçlar"
    "Kurulum" "Sürücüler, uygulamalar, masaüstü ortamları kurulumu"
    "Yapılandırma" "Dotfile'lar, ağ, takas alanı ve sanallaştırma ayarları"
    "Kapatma" "Sistemi kapatma veya yeniden başlatma seçenekleri"
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Ana Menü" --default-item "${nextitem}" --cancel-button "Çıkış" --menu "Yapılacak işlemi seçin:" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq "0" ]]; then
    case ${sel} in
    "Güncelleme")
      updatemenu
      nextitem="Kurulum"
      ;;
    "Kurulum")
      installmenu
      nextitem="Yapılandırma"
      ;;
    "Yapılandırma")
      configmenu
      nextitem="Kapatma"
      ;;
    "Kapatma")
      shutdownmenu
      nextitem="Kapatma"
      ;;
    esac
    mainmenu "${nextitem}"
  fi
}

updatemenu() {
  local nextitem="${1:-.}"
  local options=(
    "yay Kur" "AUR yardımcısı yay'ı kur"
    "paru Kur" "AUR yardımcısı paru'yu kur"
    "" ""
    "Sistemi Güncelle" "pacman -Syu komutunu çalıştır"
    "Gereksiz Bağımlılıkları Temizle" "Yalnız kalan (orphan) paketleri kaldır"
    "Packet Önbelleğini Temizle" "Pacman indirme önbelleğini temizle (pacman -Sc)"
    "" ""
    "Pacman Yapılandırmasını Düzenle" "/etc/pacman.conf dosyasını aç"
    "Mirrorlist Düzenle" "/etc/pacman.d/mirrorlist dosyasını aç"
    "" ""
    "Arch Anahtar Halkasını Güncelle" "archlinux-keyring paketini kur"
    "Pacman Anahtarlarını Yenile" "Tüm pacman anahtarlarını yenile"
  )
  if [[ -f /var/lib/pacman/db.lck ]]; then
    options+=(
      "Pacman Kilit Dosyasını Kaldır" "Pacman veritabanı kilit dosyasını (db.lck) sil"
      "" ""
    )
  fi

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Güncelleme Menüsü :" --default-item "${nextitem}" --cancel-button "Geri" --menu "Seçim yapın:" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    case ${sel} in
    "yay Kur")
      if confirm "\nyay kurulsun mu?" "" 8 60; then
        clear
        git clone https://aur.archlinux.org/yay-bin.git
        cd yay-bin || return
        makepkg -si
        cd ..
        rm -rf yay-bin
        pressanykey
      fi
      nextitem="paru Kur"
      ;;
    "paru Kur")
      if confirm "\nparu kurulsun mu?" "" 8 60; then
        clear
        git clone https://aur.archlinux.org/paru.git
        cd paru || return
        makepkg -si
        cd ..
        pressanykey
      fi
      nextitem="Sistemi Güncelle"
      ;;
    "Sistemi Güncelle")
      clear
      sudo pacman -Syu
      nextitem="Gereksiz Bağımlılıkları Temizle"
      ;;
    "Gereksiz Bağımlılıkları Temizle")
      clear
      sudo pacman -Rns $(pacman -Qqtd)
      nextitem="Packet Önbelleğini Temizle"
      ;;
    "Packet Önbelleğini Temizle")
      clear
      sudo pacman -Sc
      nextitem="Pacman Yapılandırmasını Düzenle"
      ;;
    "Pacman Yapılandırmasını Düzenle")
      clear
      sudo nvim /etc/pacman.conf
      nextitem="Mirrorlist Düzenle"
      ;;
    "Mirrorlist Düzenle")
      clear
      sudo nvim /etc/pacman.d/mirrorlist
      nextitem="Arch Anahtar Halkasını Güncelle"
      ;;
    "Arch Anahtar Halkasını Güncelle")
      clear
      sudo pacman -S archlinux-keyring
      nextitem="Pacman Anahtarlarını Yenile"
      ;;
    "Pacman Anahtarlarını Yenile")
      clear
      sudo pacman-key --refresh-keys
      nextitem="Pacman Kilit Dosyasını Kaldır"
      ;;
    "Pacman Kilit Dosyasını Kaldır")
      clear
      sudo rm /var/lib/pacman/db.lck
      nextitem="Pacman Kilit Dosyasını Kaldır"
      ;;
    esac

    updatemenu "${nextitem}"
  fi
}

installmenu() {
  local nextitem="${1:-.}"
  local options=(
    "Sürücüler" "Grafik, ses ve diğer donanım bileşenlerinin sürücüleri"
    "Uygulamalar" "Genel kullanıcı uygulamaları ve system araçları"
    "Yazı Tipleri" "Font (yazı tipi) setlerinin kurulumu"
    "Temalar" "Tema, ikon ve imleç setlerinin kurulumu"
    "Masaüstü Ortamları" "DE (KDE, Gnome vb.) ve Pencere Yöneticisi kurulumu"
    "Görüntü Yöneticileri" "Giriş (login) ekranı yöneticileri (GDM, SDDM, vb.)"
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Kurulum Menüsü" --default-item "${nextitem}" --cancel-button "Geri" --menu "Ne kurmak istersiniz?" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    case ${sel} in
    "Sürücüler")
      driversmenu
      nextitem="Uygulamalar"
      ;;
    "Uygulamalar")
      menu_main_applications
      nextitem="Yazı Tipleri"
      ;;
    "Yazı Tipleri")
      fonts
      nextitem="Temalar"
      ;;
    "Temalar")
      themes
      nextitem="Masaüstü Ortamları"
      ;;
    "Masaüstü Ortamları")
      demenu
      nextitem="Görüntü Yöneticileri"
      ;;
    "Görüntü Yöneticileri")
      displaymanager
      nextitem="Görüntü Yöneticileri"
      ;;
    esac
    installmenu "${nextitem}"
  fi
}

# --------------------------
# SÜRÜCÜ MENÜLERİ
# --------------------------

driversmenu() {
  local nextitem="${1:-.}"
  local options=(
    "AMD" "AMD/Radeon grafik sürücüleri ve hızlandırmalar"
    "NVIDIA" "NVIDIA sürücüleri ve ilgili ayarlar"
    "NVIDIA VA-API" "NVIDIA video hızlandırma (VA-API) desteği"
    "ASUS" "ROG/TUF laptop araçları (asusctl, supergfxctl, vb.)"
    "Ses Sistemi" "Pipewire, Wireplumber ve ilgili ses araçları"
    "mkinitcpio Firmware" "(AUR) Çekirdek ön yükleme için gerekli firmware dosyaları"
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Sürücüler" --default-item "${nextitem}" --cancel-button "Geri" --menu "Sürücü seçimi yapın:" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    case ${sel} in
    "AMD")
      amddriver
      nextitem="NVIDIA"
      ;;
    "NVIDIA")
      nvidiadriver
      nextitem="NVIDIA VA-API"
      ;;
    "NVIDIA VA-API")
      nvidia_vaapi
      nextitem="ASUS"
      ;;
    "ASUS")
      asusdriver
      nextitem="Ses Sistemi"
      ;;
    "Ses Sistemi")
      sounddriver
      nextitem="mkinitcpio Firmware"
      ;;
    "mkinitcpio Firmware")
      if confirm "\nFirmware kurulsun mu?" "" 8 60; then
        clear
        instpkg "" mkinitcpio-firmware
        pressanykey
      fi
      nextitem="mkinitcpio Firmware"
      ;;
    esac
    driversmenu "${nextitem}"
  fi
}

amddriver() {
  local options=(
    "mesa" "" on
    "lib32-mesa" "" on
    "xf86-video-amdgpu" "" on
    "vulkan-radeon" "" on
    "lib32-vulkan-radeon" "" on
    "libva-mesa-driver" "" on
    "lib32-libva-mesa-driver" "" on
    "mesa-vdpau" "" on
    "lib32-mesa-vdpau" "" on
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "AMD/Radeon Sürücüleri" --cancel-button "Geri" --checklist "Paketleri seçin:" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      # aurpkg="$aurpkg $item"
      pkg="$pkg $item"
    done

    instpkg "$pkg" "$aurpkg"

    if pacman -Qq mesa &>/dev/null; then
      if confirm "\nGerekli çekirdek modülleri uygulansın mı?" "" 8 60; then
        clear
        configure_amd_modules
      fi
    fi
  fi
}

configure_amd_modules() {
  local gpumodule="amdgpu radeon"

  # Update /etc/mkinitcpio.conf
  local presentmkinitcpiomodules
  presentmkinitcpiomodules=$(grep '^MODULES=' /etc/mkinitcpio.conf | awk -F '[()]' '{print $2}')

  if [[ -z $presentmkinitcpiomodules ]]; then
    sudo sed -i "s/MODULES=()/MODULES=(${gpumodule})/" /etc/mkinitcpio.conf
  elif ! echo $presentmkinitcpiomodules | grep -q "$gpumodule"; then
    local newmkinitcpiomodules="${presentmkinitcpiomodules} ${gpumodule}"
    sudo sed -i "s/MODULES=(${presentmkinitcpiomodules})/MODULES=(${newmkinitcpiomodules})/" /etc/mkinitcpio.conf
  else
    echo "$gpumodule - İlgili modüller zaten mevcut..."
    pressanykey
  fi

  sudo mkinitcpio -P
}

nvidiadriver() {
  local options=(
    "nvidia" "" off
    "nvidia-lts" "" off
    "nvidia-dkms" "" off
    "nvidia-open" "" off
    "nvidia-open-dkms" "" on
    "nvidia-utils" "" on
    "lib32-nvidia-utils" "" on
    "nvidia-settings" "" on
    "egl-wayland" "" on
    "libva-nvidia-driver" "" on
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "NVIDIA Sürücüleri" --cancel-button "Geri" --checklist "Paketleri seçin:" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      # aurpkg="$aurpkg $item"
      pkg="$pkg $item"
    done

    instpkg "$pkg" "$aurpkg"

    if pacman -Qs nvidia &>/dev/null; then
      if confirm "\nGerekli çekirdek modülleri uygulansın mı?" "" 8 60; then
        clear
        configure_nvidia_modules
      fi
    fi
  fi
}

configure_nvidia_modules() {
  local gpumodule="nvidia nvidia_modeset nvidia_uvm nvidia_drm"
  local gpukernel="modeset=1"

  # Update /etc/mkinitcpio.conf
  local presentmkinitcpiomodules
  presentmkinitcpiomodules=$(grep '^MODULES=' /etc/mkinitcpio.conf | awk -F '[()]' '{print $2}')

  if [[ -z "$presentmkinitcpiomodules" ]]; then
    sudo sed -i "s/^MODULES=()/MODULES=(${gpumodule})/" /etc/mkinitcpio.conf
  elif ! echo "$presentmkinitcpiomodules" | grep -q "$gpumodule"; then
    local newmkinitcpiomodules="${presentmkinitcpiomodules} ${gpumodule}"
    sudo sed -i "s/^MODULES=(${presentmkinitcpiomodules})/MODULES=(${newmkinitcpiomodules})/" /etc/mkinitcpio.conf
  else
    echo "$gpumodule - İlgili modüller zaten mevcut..."
    pressanykey
  fi

  sudo mkinitcpio -P

  if [[ ! -f /etc/modprobe.d/nvidia.conf ]]; then
    echo "options nvidia_drm modeset=1 fbdev=1" | sudo tee /etc/modprobe.d/nvidia.conf >/dev/null
    sudo mkinitcpio -P
    pressanykey
  fi

  if [[ -f /etc/kernel/cmdline ]]; then
    local presentkernelcmdline
    presentkernelcmdline=$(cat /etc/kernel/cmdline 2>/dev/null)

    if [[ -n "$presentkernelcmdline" ]]; then
      if ! echo "$presentkernelcmdline" | grep -q "$gpukernel"; then
        local newkernelcmdline="${presentkernelcmdline} ${gpukernel}"
        echo "$newkernelcmdline" | sudo tee /etc/kernel/cmdline >/dev/null
        sudo mkinitcpio -P
      else
        echo "$gpukernel - İlgili modüller zaten mevcut..."
        pressanykey
      fi
    fi
  fi
}

nvidia_vaapi() {
  local options=(
    "meson" "" on
    "gst-plugins-bad" "" on
    "ffnvcodec-headers" "" on
  )

  sel=$(dialog --backtitle "$apptitle" --title "NVIDIA VA-API Bağımlılıkları" --cancel-button "Geri" --checklist "Paketleri seçin:" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      # aurpkg="$aurpkg $item"
      pkg="$pkg $item"
    done

    instpkg "$pkg" "$aurpkg"

    if pacman -Qq ffnvcodec-headers &>/dev/null; then
      clear
      git clone https://github.com/elFarto/nvidia-vaapi-driver.git
      cd nvidia-vaapi-driver || return
      meson setup build
      meson install -C build
      cd ..
      rm -rf nvidia-vaapi-driver
      echo "nvidia-vaapi-driver is successfully installed"
      pressanykey
    fi
  fi
}

asusdriver() {
  # Check if the [g14] repository is enabled in pacman.conf
  local isg14repo
  isg14repo=$(grep -i "^\[g14\]" /etc/pacman.conf >/dev/null && echo true || echo false)

  # Define package options based on the repository status
  local options
  if $isg14repo; then
    options=(
      "asusctl" "" on
      "power-profiles-daemon" "" on
      "supergfxctl" "" on
      "switcheroo-control" "" on
      "rog-control-center" "" on
      "brightnessctl" "" on
    )
  else
    options=(
      "asusctl" "(AUR)" on
      "power-profiles-daemon" "" on
      "supergfxctl" "(AUR)" on
      "switcheroo-control" "" on
      "rog-control-center" "(AUR)" on
      "brightnessctl" "" on
    )
  fi

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "ASUS ROG/TUF Araçları" --cancel-button "Geri" --checklist "Paketleri seçin:" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg=""
    local aurpkg=""

    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      if $isg14repo; then
        # aurpkg="$aurpkg $item"
        pkg="$pkg $item"
      else
        case $item in
        "asusctl" | "supergfxctl" | "rog-control-center")
          aurpkg="$aurpkg $item"
          ;;
        *)
          pkg="$pkg $item"
          ;;
        esac
      fi
    done

    instpkg "$pkg" "$aurpkg"

    serviceenable power-profiles-daemon
    serviceenable supergfxd
    serviceenable switcheroo-control
  fi
}

sounddriver() {
  local options=(
    "wireplumber" "" on
    "pipewire" "" on
    "pipewire-alsa" "" on
    "pipewire-pulse" "" on
    "pipewire-jack" "" on
    "pipewire-v4l2" "" on
    "pipewire-zeroconf" "" on
    "pipewire-x11-bell" "" off
    "easyeffects" "" off
    "jamesdsp-pipewire-bin" "(AUR)" off
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Ses Sistemi (Pipewire)" --cancel-button "Geri" --checklist "Paketleri seçin:" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      case $item in
      "jamesdsp-pipewire-bin") aurpkg="$aurpkg $item" ;;
      *) pkg="$pkg $item" ;;
      esac
    done

    instpkg "$pkg" "$aurpkg"
  fi
}

# --------------------------
# UYGULAMA MENÜLERİ
# --------------------------

# Ana Uygulama Menüsü
menu_main_applications() {
  local nextitem="${1:-.}"
  local options=(
    "Konsol" ""
    "Sıkıştırma araçları" ""
    "Programlama" ""
    "Dosya sistemleri" ""
    "Sistem" ""
    "İnternet" ""
    "Ortak uygulamalar" ""
    "Dosya gezginleri" ""
    "Multimedya" ""
    "Tema Motoru" ""
    "Oyunlar" ""
    "Diğer" ""
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Uygulamalar :" --default-item "${nextitem}" --cancel-button "Geri" --menu "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    case ${sel} in
    "Konsol")
      console_apps
      nextitem="Sıkıştırma araçları"
      ;;
    "Sıkıştırma araçları")
      compression_tools
      nextitem="Programlama"
      ;;
    "Programlama")
      programming_tools
      nextitem="Dosya sistemleri"
      ;;
    "Dosya sistemleri")
      filesystem_tools
      nextitem="Sistem"
      ;;
    "Sistem")
      system_apps
      nextitem="İnternet"
      ;;
    "İnternet")
      internet_apps
      nextitem="Ortak uygulamalar"
      ;;
    "Ortak uygulamalar")
      common_apps
      nextitem="Dosya gezginleri"
      ;;
    "Dosya gezginleri")
      file_browsers
      nextitem="Multimedya"
      ;;
    "Multimedya")
      multimedia_apps
      nextitem="Tema Motoru"
      ;;
    "Tema Motoru")
      theme_engines
      nextitem="Oyunlar"
      ;;
    "Oyunlar")
      game_launchers
      nextitem="Diğer"
      ;;
    "Diğer")
      other_apps
      nextitem="Diğer"
      ;;
    esac

    menu_main_applications "${nextitem}"
  fi
}

# --- Konsol Uygulamaları Seçimi ---
console_apps() {
  local options=(
    "cmatrix" "" off
    "cmatrix-neo-git" "(AUR)" off
    "wget" "" on
    "fastfetch" "" on
    "mpv" "" on
    "mc" "" on
    "mlocate" "" on
    "fd" "" on
    "ripgrep" "" on
    "btop" "" on
    "nvtop" "" on
    "bat" "" on
    "xsel" "" on
    "xclip" "" off
    "wl-clipboard" "" on
    "zsh" "" on
    "pkgfile" "" on
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Konsol uygulamaları :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      case $item in
      "cmatrix-neo-git") aurpkg="$aurpkg $item" ;;
      *) pkg="$pkg $item" ;;
      esac
    done

    # Seçilen paketleri kur
    instpkg "$pkg" "$aurpkg"
  fi
}

# --- Sıkıştırma Araçları Seçimi ---
compression_tools() {
  local options=(
    "tar" "" on
    "zip" "" on
    "unzip" "" on
    "unrar" "" on
    "p7zip" "" on
    "lzop" "" on
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Sıkıştırma araçları :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      pkg="$pkg $item"
    done

    # Seçilen paketleri kur
    instpkg "$pkg" "$aurpkg"
  fi
}

# --- Programlama Araçları Seçimi ---
programming_tools() {
  local options=(
    "python" "" on
    "python-psutil" "" on
    "python-requests" "" on
    "go" "" on
    "go-tools" "" on
    "codespell" "" on
    "npm" "" on
    "yarn" "" on
    "xmlstarlet" "" on
    "luarocks" "" on
    "ruby" "" on
    "rubygems" "" on
    "composer" "" on
    "php" "" on
    "julia" "" on
    "jq" "" on
    "cpanminus" "" on
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Programlama dilleri ve araçları :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      pkg="$pkg $item"
    done

    # Seçilen paketleri kur
    instpkg "$pkg" "$aurpkg"
  fi
}

# --- Dosya Sistemleri Araçları Seçimi ---
filesystem_tools() {
  local options=(
    "gvfs" "" on
    "gvfs-mtp" "" on
    "gvfs-smb" "" on
    "gvfs-nfs" "" on
    "gvfs-afc" "" off
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Dosya sistemleri araçları :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      pkg="$pkg $item"
    done

    # Seçilen paketleri kur
    instpkg "$pkg" "$aurpkg"
  fi
}

# --- Sistem Uygulamaları Seçimi ---
system_apps() {
  local options=(
    "gnome-disk-utility" "" on
    "gparted" "(GTK) Disk bölme yöneticisi" off
    "acpi" "" on
    "acpi_call-dkms" "" on
    "lm_sensors" "" on
    "lib32-lm_sensors" "" on
    "os-prober" "Çoklu önyükleme için OS tespiti (grub)" off
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Sistem uygulamaları :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      pkg="$pkg $item"
    done

    # Seçilen paketleri kur
    instpkg "$pkg" "$aurpkg"
  fi
}

# --- İnternet Uygulamaları Seçimi ---
internet_apps() {
  local options=(
    "firefox" "" on
    "thunderbird" "" off
    "zen-browser-bin" "(AUR)" on
    "uget" "" off
    "transmission-gtk" "" off
    "transmission-qt" "" off
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "İnternet uygulamaları :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" = 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      case $item in
      "zen-browser-bin") aurpkg="$aurpkg $item" ;;
      *) pkg="$pkg $item" ;;
      esac
    done

    # Seçilen paketleri kur
    instpkg "$pkg" "$aurpkg"

    # Ek paketleri kur (dil paketleri)
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      case $item in
      "firefox") choosepkg "firefox-i18n-" ;;
      "thunderbird") choosepkg "thunderbird-i18n-" ;;
      esac
    done
  fi
}

# --- Ortak Uygulamalar Seçimi ---
common_apps() {
  local options=(
    "libreoffice-fresh" "" off
    "libreoffice-still" "" off
    "openrgb" "" on
    "solaar" "Logitech fare desteği" off
    "waydroid" "(AUR)" on
    "waydroid-helper" "(AUR)" on
    "kate" "" on
    "mousepad" "" off
    "gnome-text-editor" "" off
    "bleachbit" "Profil temizleyici" off
    "webapp-manager" "(AUR)" on
    "stacer-bin" "(AUR)" off
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Ortak uygulamalar :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""

    # Seçilen öğeleri işle
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      case $item in
      "waydroid" | "waydroid-helper" | "webapp-manager" | "stacer-bin")
        aurpkg="$aurpkg $item"
        ;;
      *) pkg="$pkg $item" ;;
      esac
    done

    # Seçilen paketleri kur
    instpkg "$pkg" "$aurpkg"

    # LibreOffice bileşenlerini kur
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      case $item in
      "libreoffice-fresh") choosepkg "libreoffice-fresh-" ;;
      "libreoffice-still") choosepkg "libreoffice-still-" ;;
      esac
    done

    # Waydroid bağımlılıklarını yönet
    if [[ "${sel}" == *"waydroid"* ]]; then
      if ! pacman -Qq linux-zen &>/dev/null; then
        if confirm "Waydroid en iyi linux-zen çekirdeği ile çalışır.\nBunun yerine binder_linux-dkms kurulsun mu?" "" 10 60; then
          config_waydroid_dependencies
        fi
      fi
    fi
  fi
}

# --- Waydroid Bağımlılık Yapılandırması (Fonksiyon Adı Korundu) ---
config_waydroid_dependencies() {
  local options=(
    "binder_linux-dkms" "(AUR)" on
    "python-pyclip" "(AUR)" on
    "waydroid-helper" "(AUR)" off
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Waydroid bağımlılıkları :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""

    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      case $item in
      "binder_linux-dkms" | "python-pyclip" | "waydroid-helper")
        aurpkg="$aurpkg $item"
        ;;
      *) pkg="$pkg $item" ;;
      esac
    done

    # Seçilen paketleri kur
    instpkg "$pkg" "$aurpkg"

    # Çekirdek komut satırını güncelle
    local presentkernelcmdline
    presentkernelcmdline=$(cat /etc/kernel/cmdline 2>/dev/null)

    if ! grep -q "binder" <<<"$presentkernelcmdline"; then
      local newkernelcmdline="${presentkernelcmdline} device=binder,hwbinder,vndbinder"
      echo "$newkernelcmdline" | sudo tee /etc/kernel/cmdline >/dev/null
      sudo mkinitcpio -P
      serviceenable waydroid-container
      message "Waydroid başarıyla kuruldu.\nÇalıştırmadan önce yeniden başlatın!" "" 8 60
    else
      message "Binder modülleri çekirdek komut satırında zaten mevcut." "" 8 60
    fi
  fi
}

# --- Dosya Gezginleri Seçimi ---
file_browsers() {
  local options
  options=(
    "archlinux-xdg-menu" "" on
    "yazi" "" on
    "dolphin" "KDE" on
    "dolphin-plugins" "KDE" on
    "kdenetwork-filesharing" "KDE" on
    "ffmpegthumbs" "KDE" on
    "ark" "KDE" on
    "thunar" "XFCE" off
    "thunar-volman" "XFCE" off
    "thunar-archive-plugin" "XFCE" off
    "thunar-shares-plugin" "(AUR)" off
    "file-roller" "" off
    "tumbler" "" off
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Dosya gezginleri :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      case $item in
      "thunar-shares-plugin") aurpkg="$aurpkg $item" ;;
      *) pkg="$pkg $item" ;;
      esac
    done

    instpkg "$pkg" "$aurpkg"

    if [[ "${sel}" == *"yazi"* ]]; then
      options=(
        "ffmpegthumbnailer" "" on
        "p7zip" "" on
        "jq" "" on
        "poppler" "" on
        "fd" "" on
        "ripgrep" "" on
        "fzf" "" on
        "zoxide" "" on
        "imagemagick" "" on
        "perl-image-exiftool" "" on
      )

      sel=$(dialog --backtitle "$apptitle" --title "Yazi bağımlılıkları :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

      for item in $sel; do
        item=$(echo "$item" | tr -d '"')
        pkg="$pkg $item"
      done

      instpkg "$pkg" "$aurpkg"
    fi
  fi
}

# --- Multimedya Uygulamaları Seçimi ---
multimedia_apps() {
  local options=(
    "smplayer" "" off
    "smplayer-skins" "" off
    "smplayer-themes" "" off
    "elisa" "" off
    "gst-plugins-base" "" on
    "gst-plugins-good" "" on
    "gst-plugins-ugly" "" on
    "gst-plugins-bad" "" on
    "gst-plugin-pipewire" "" on
    "gst-libav" "" on
    "libde265" "" on
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Multimedya yazılımı ve uygulamaları :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      pkg="$pkg $item"
    done

    instpkg "$pkg" "$aurpkg"
  fi
}

# --- Tema Motorları Seçimi ---
theme_engines() {
  local options=(
    "lxappearance" "(GTK)" off
    "nwg-look" "(GTK)" off
    "kvantum" "(QT6)" off
    "kvantum-qt5" "(QT5)" off
    "qt5ct" "" off
    "qt6ct" "" off
    "qt6ct-kde" "(AUR)" off
    "darkly-bin" "(AUR)" on
    "darkly-qt6-git" "(AUR)" off
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Tema Motoru :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""

    if [[ "${sel}" == *"darkly"* ]]; then
      install_darkly_deps
    fi

    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      case $item in
      "qt6ct-kde" | "darkly-bin" | "darkly-qt5-git" | "darkly-qt6-git")
        aurpkg="$aurpkg $item"
        ;;
      *) pkg="$pkg $item" ;;
      esac
    done

    instpkg "$pkg" "$aurpkg"
  fi
}

# --- Darkly Tema Bağımlılıkları Kurulumu (Fonksiyon Adı Korundu) ---
install_darkly_deps() {
  local options=(
    "cmake" "" on
    "extra-cmake-modules" "" on
    "frameworkintegration" "" on
    "frameworkintegration5" "" on
    "gcc" "" on
    "git" "" on
    "kcmutils" "" on
    "kcmutils5" "" on
    "kcolorscheme" "" on
    "kconfig" "" on
    "kconfigwidgets5" "" on
    "kcoreaddons" "" on
    "kdecoration" "" on
    "kguiaddons" "" on
    "kiconthemes" "" on
    "kiconthemes5" "" on
    "kirigami2" "" on
    "kwindowsystem" "" on
    "kwindowsystem5" "" on
    "libplasma" "" on
    "make" "" on
    "qt5-declarative" "" on
    "qt5-x11extras" "" on
    "qt6-declarative" "" on
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Darkly bağımlılıkları :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      pkg="$pkg $item"
    done

    instpkg "$pkg" "$aurpkg"
  fi
}

# --- Oyun Başlatıcıları Seçimi ---
game_launchers() {
  local options=(
    "steam" "" off
    "heroic-games-launcher-bin" "(AUR)" off
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Oyun başlatıcıları :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      case $item in
      "heroic-games-launcher-bin")
        aurpkg="$aurpkg $item"
        ;;
      *) pkg="$pkg $item" ;;
      esac
    done

    instpkg "$pkg" "$aurpkg"
  fi
}

# --- Diğer Uygulamalar Ana Menüsü ---
other_apps() {
  local options=(
    "Virt Manager" ""
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Diğer uygulamalar :" --cancel-button "Geri" --menu "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)
  case $sel in
  "Virt Manager")
    virt_manager_packages
    ;;
  esac
}

# --- Virt Manager Packet Seçimi ---
virt_manager_packages() {
  local options=(
    "libvirt" "" on
    "iptables-nft" "" on
    "dnsmasq" "" on
    "openbsd-netcat" "" on
    "dmidecode" "" on
    "qemu-desktop" "" on
    "virt-manager" "" on
    "virt-viewer" "" on
    "bridge-utils" "" on
    "swtpm" "" on
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Virt Manager paketleri :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      pkg="$pkg $item"
    done

    instpkg "$pkg" "$aurpkg"

    if (pacman -Qq libvirt >/dev/null); then
      config_virt_manager
    fi
  fi
}

# --- Virt Manager Yapılandırması ---
config_virt_manager() {
  clear

  # libvirtd.conf yedeğini al
  if [[ -f /etc/libvirt/libvirtd.conf ]]; then
    sudo cp /etc/libvirt/libvirtd.conf /etc/libvirt/libvirtd.conf.bak
  fi
  # libvirtd.conf yapılandır
  if ! grep -q "unix_sock_group = 'libvirt'" /etc/libvirt/libvirtd.conf; then
    printf "\nunix_sock_group = 'libvirt'\nunix_sock_rw_perms = '0770'\n" |
      sudo tee -a /etc/libvirt/libvirtd.conf >/dev/null
  else
    echo "/etc/libvirt/libvirtd.conf zaten değiştirilmiş..."
  fi

  # qemu.conf yapılandır
  if ! grep -q "user = \"$localuser\"" /etc/libvirt/qemu.conf; then
    printf "\n# Kullanıcı Ayarları\nuser = \"%s\"\ngroup = \"%s\"\n" "$localuser" "$localuser" |
      sudo tee -a /etc/libvirt/qemu.conf >/dev/null
  else
    echo "/etc/libvirt/qemu.conf zaten değiştirilmiş..."
  fi

  # network.conf yapılandır
  if ! grep -q "firewall_backend=\"iptables\"" /etc/libvirt/network.conf; then
    printf "\nfirewall_backend=\"iptables\"\n" |
      sudo tee -a /etc/libvirt/network.conf >/dev/null
  else
    echo "/etc/libvirt/network.conf zaten yapılandırılmış..."
  fi

  # mkinitcpio.conf güncelle
  local virtmodule="virtio virtio_blk virtio_pci virtio_net"
  local presentmkinitcpiomodules
  presentmkinitcpiomodules=$(grep '^MODULES=' /etc/mkinitcpio.conf | awk -F '[()]' '{print $2}')

  if [[ -z "$presentmkinitcpiomodules" ]]; then
    sudo sed -i "s/^MODULES=()/MODULES=(${virtmodule})/" /etc/mkinitcpio.conf
  elif ! echo "$presentmkinitcpiomodules" | grep -qw "virtio"; then
    local newmkinitcpiomodules="${presentmkinitcpiomodules} ${virtmodule}"
    sudo sed -i "s/^MODULES=(${presentmkinitcpiomodules})/MODULES=(${newmkinitcpiomodules})/" /etc/mkinitcpio.conf
  else
    echo "$virtmodule - İlgili modüller zaten mevcut..."
  fi

  # Grupları mevcut değilse oluştur
  for group in libvirt kvm; do
    if ! getent group "$group" >/dev/null; then
      sudo groupadd -f "$group" 2>/dev/null
    fi
  done

  # Varsayılan ağı yapılandır
  sudo virsh net-autostart default
  sudo virsh net-start default

  # Kullanıcıyı gruplara ekle
  sudo usermod -aG kvm,libvirt "$localuser"

  # Servisleri etkinleştir
  serviceenable libvirtd.service
  serviceenable virtlogd.service
}

# --------------------------
# FONT, TEMA, DE VE DM MENÜLERİ
# --------------------------

fonts() {
  local options=(
    "ttf-jetbrains-mono-nerd" "" on
    "ttf-fantasque-nerd" "" on
    "ttf-ubuntu-nerd" "" on
    "ttf-ubuntu-mono-nerd" "" on
    "ttf-hack-nerd" "" on
    "ttf-firacode-nerd" "" on
    "otf-font-awesome" "" on
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Yazı Tipleri" --cancel-button "Geri" --checklist "Paketleri seçin:" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      case $item in
      # "") aurpkg="$aurpkg $item" ;;
      *) pkg="$pkg $item" ;;
      esac
    done
    instpkg "$pkg" "$aurpkg"
  fi
}

themes() {
  local nextitem="${1:-.}"
  local options=(
    "Qogir icon theme" ""
    "Tokyonight GTK theme" ""
    "Mocu xcursor" ""
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Temalar" --default-item "${nextitem}" --cancel-button "Geri" --menu "Seçim yapın:" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    case $sel in
    "Qogir icon theme")
      instpkg "" "qogir-icon-theme"
      nextitem="Tokyonight GTK theme"
      ;;
    "Tokyonight GTK theme")
      instpkg "" "tokyonight-gtk-theme-git"
      nextitem="Mocu xcursor"
      ;;
    "Mocu xcursor")
      instpkg "" "mocu-xcursor"
      nextitem="Mocu xcursor"
      ;;
    esac
    themes "${nextitem}"
  fi

}

demenu() {
  local nextitem="${1:-.}"
  local options=(
    "Hyprland" "Popüler döşemeli pencere yöneticisi"
    "Plasma" "KDE Plasma Masaüstü Ortamı"
    "Gnome" "GNOME Masaüstü Ortamı"
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Görüntü yöneticisi :" --default-item "${nextitem}" --cancel-button "Back" --menu "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    case $sel in
    "Hyprland")
      hyprland
      nextitem="Plasma"
      ;;
    "Plasma")
      plasma
      nextitem="Gnome"
      ;;
    "Gnome")
      gnome
      nextitem="Gnome"
      ;;
    esac
    demenu "${nextitem}"
  fi
}

hyprland() {
  local options=(
    "hyprland" "" on
    "hyprpaper" "" on
    "hyprpicker" "" on
    "hypridle" "" on
    "hyprlock" "" on
    "hyprcursor" "" on
    "hyprpolkitagent" "" on
    "xdg-desktop-portal-hyprland" "" on
    "qt5-wayland" "" on
    "qt6-wayland" "" on
    "kitty" "" on
    "rofi" "" on
    "walker" "(AUR)" off
    "elephant" "(AUR)" off
    "elephant-desktopapplications" "(AUR)" off
    "elephant-archlinuxpkgs" "(AUR)" off
    "waybar" "" on
    "waybar-updates" "(AUR)" on
    "wleave-git" "(AUR)" off
    "wlogout" "(AUR)" on
    "mako" "" on
    "libnotify" "" on
    "cliphist" "" on
    "waypaper" "(AUR)" on
    "swappy" "" on
    "swww" "" on
    "imv" "" on
    "grim" "" on
    "slurp" "" on
    "swaybg" "" on
    "playerctl" "" on
    "pamixer" "" on
    "pavucontrol" "" on
    "bluetui" "Bluetooth kontrol uygulaması (TUI)" on
    "impala" "iwd için uygulama (TUI)" on
    "brightnessctl" "" off
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Hyprland" --cancel-button "Geri" --checklist "Paketleri seçin:" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      case $item in
      "walker" | "elephant" | "elephant-desktopapplications" | "elephant-archlinuxpkgs" | "wleave-git" | "wlogout" | "waybar-updates" | "waypaper")
        aurpkg="$aurpkg $item"
        ;;
      *) pkg="$pkg $item" ;;
      esac
    done
    instpkg "$pkg" "$aurpkg"
  fi
}

plasma() {
  local options=(
    "plasma" "Plasma Masaüstü Ortamı (Temel)" on
    "plasma-wayland-protocols" "Wayland için gerekli protokoller" on
    "ark" "Arşiv yöneticisi (zip, rar, 7z vb.)" on
    "dolphin" "Varsayılan dosya yöneticisi" on
    "dolphin-plugins" "Dolphin eklentileri" on
    "ffmpegthumbs" "Video küçük resim önizlemeleri" on
    "gwenview" "Görüntüleyici" on
    "kalzium" "Periyodik tablo (Eğitim)" off
    "kate" "Gelişmiş metin düzenleyici" on
    "kcharselect" "Özel karakter seçici" on
    "kcolorchooser" "Renk seçici (Color Picker)" on
    "kdeconnect" "Cihaz entegrasyonu (Telefon/PC)" on
    "kdegraphics-thumbnailers" "Grafik küçük resim önizlemeleri" on
    "kdenetwork-filesharing" "Ağda dosya paylaşımı" on
    "kdesdk-thumbnailers" "SDK ile ilgili küçük resim önizlemeleri" on
    "kdialog" "KDE/Plasma diyalog araçları" on
    "kfind" "Gelişmiş dosya arama aracı" on
    "kio-extras" "Ek KIO eklentileri (ağ/uzak dosya sistemleri)" on
    "kio-gdrive" "Google Drive entegrasyonu" on
    "kolourpaint" "Basit boyama programı" on
    "konsole" "Terminal emülatörü" on
    "ksystemlog" "Sistem kayıtlarını görüntüleyici" on
    "ktouch" "On Parmak Yazma Eğitimi" off
    "lokalize" "Çeviri / Yerelleştirme aracı" off
    "okular" "Belge görüntüleyici (PDF, EPUB vb.)" on
    "print-manager" "Yazdırma yöneticisi" on
    "spectacle" "Ekran görüntüsü aracı" on
    "kdiskmark" "Disk performans test aracı" on
    "plasma-discover" "Grafiksel packet yöneticisi (Uygulama Mağazası)" on
    "discover-notifier" "Discover bildirim aracı" on
    # Latte Dock paketleri (latte-dock ve latte-dock-git) güncel olmadığı için listeden çıkarıldı.
    "plasma5-applets-virtual-desktop-bar-git" "(AUR) Sanal Masaüstü Çubuğu" off
    "plasma5-applets-window-appmenu-git" "(AUR) Pencere Uygulama Menüsü" off
    "sddm-conf-git" "(AUR) SDDM konfigürasyon aracı" off
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "KDE Plasma Uygulamaları :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      case $item in
      "plasma5-applets-virtual-desktop-bar-git" | "plasma5-applets-window-appmenu-git" | "sddm-conf-git")
        aurpkg="$aurpkg $item"
        ;;
      *) pkg="$pkg $item" ;;
      esac
    done

    # Seçilen paketleri kur
    instpkg "$pkg" "$aurpkg"
  fi
}

gnome() {
  local options=(
    "gnome-shell" "GNOME Masaüstü Kabuğu" on
    "mutter" "Pencere Yöneticisi ve Besteci" on
    "gnome-control-center" "Ayarlar Uygulaması" on
    "nautilus" "Dosya Yöneticisi" on
    "gnome-terminal" "Terminal Emülatörü" on
    "gnome-text-editor" "Modern Metin Düzenleyici (gedit yerine)" on
    "gnome-software" "Grafiksel packet yöneticisi (Uygulama Mağazası)" on
    "gnome-tweaks" "Ek GNOME ayar aracı" on
    "gnome-shell-extensions" "Kabuk uzantıları" on
    "gnome-keyring" "Şifre ve anahtar yöneticisi" on
    "gnome-disk-utility" "Disk ve bölümleme aracı" on
    "gnome-calculator" "Hesap makinesi" on
    "evince" "Belge görüntüleyici (PDF, EPUB vb.)" on
    "file-roller" "Arşiv yöneticisi (zip, rar vb.)" on
    "eog" "Görüntüleyici (Eye of GNOME)" on
    "sushi" "Nautilus için dosya önizleme" on
    "xdg-user-dirs-gtk" "Kullanıcı dizinlerini oluşturur (Masaüstü, İndirilenler vb.)" on
    "baobab" "Disk kullanım analizörü" on
    "gnome-calendar" "Takvim" on
    "gnome-characters" "Özel karakterler" on
    "gnome-color-manager" "Renk yönetimi" on
    "gnome-font-viewer" "Yazı tipi görüntüleyici" on
    "gnome-logs" "Sistem kayıt görüntüleyicisi" on
    "gnome-menus" "Menü sistemi" on
    "gnome-photos" "Fotoğraf görüntüleyici ve düzenleyici" on
    "gnome-remote-desktop" "Uzak masaüstü erişimi" on
    "gnome-session" "GNOME oturumu" on
    "gnome-settings-daemon" "Ayarlar arka plan hizmeti" on
    "gnome-themes-extra" "Ek GNOME temaları" on
    "gnome-user-docs" "Kullanıcı belgeleri" on
    "gnome-user-share" "Kullanıcı paylaşımını etkinleştirir" on
    "grilo-plugins" "Multimedya çerçeve eklentileri" on
    "gnome-sudoku" "Sudoku Oyunu" off
    "gnome-sound-recorder" "Ses kayıt aracı" off
    "gnome-nettool" "Ağ araçları (Tercihe bağlı/Eski)" off
    "gnome-mines" "Mayın Tarlası Oyunu" off
    "gnome-mahjongg" "Mahjong Oyunu" off
    "gnome-chess" "Satranç Oyunu" off
    "ghex" "Hex Düzenleyici" off
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "GNOME Uygulamaları :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      # GNOME için AUR paketi yok, tüm seçilenler ana packet olarak işleniyor.
      pkg="$pkg $item"
    done

    # Seçilen paketleri kur
    instpkg "$pkg" "$aurpkg"
  fi
}

displaymanager() {
  local options=(
    "gdm" "Gnome Giriş Yöneticisi"
    "sddm" "QT Giriş Yöneticisi"
    "sddm-git" "(AUR)"
    "regreet" "Ayarları tamamlanmadı"
    "lxdm" "LXDE Giriş Yöneticisi"
    "lightdm-gtk-greeter" "Diğer Giriş Yöneticisi"
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Display Manager :" --cancel-button "Back" --menu "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    case $sel in
    "gdm")
      instpkg "gdm" ""
      serviceenable gdm
      ;;
    "sddm")
      instpkg "sddm" ""
      serviceenable sddm
      ;;
    "sddm-git")
      instpkg "" "sddm-git"
      serviceenable sddm
      ;;
    "regreet")
      instpkg "greetd-regreet" ""
      regreet_configuration
      serviceenable greetd
      ;;
    "lxdm")
      instpkg "lxdm" ""
      serviceenable lxdm
      ;;
    "lightdm-gtk-greeter")
      instpkg "lightdm-gtk-greeter" ""
      serviceenable lightdm
      ;;
    esac
  fi
}

regreet_configuration() {
  sudo mkdir -p /etc/greetd

  printf "%s\n" "[terminal]" "vt = 1" "" "[default_session]" "command = \"Hyprland --config /home/"$localuser"/.config/regreet/hyprland.conf\"" "user = \"$localuser\"" | sudo tee /etc/greetd/config.toml >/dev/null

  sudo usermod -a -G video "$localuser"
  sudo chown "$localuser":"$localuser" /etc/greetd
}

# --------------------------
# KONFİGÜRASYON MENÜLERİ
# --------------------------

# Yapılandırma Ana Menüsü
configmenu() {
  local nextitem="${1:-.}"
  local options=(
    "Dotfile'lar" "Kullanıcı yapılandırma dosyaları"
    "Takas Dosyası Yapılandırması" "Hazırda bekletme (hibernation) için çekirdek modülü ayarı (systemd-boot)"
    "Ağ Yapılandırması" "Dosya paylaşımı ve keşif ayarları"
    "TR klavye desteği" "tr, pc105 --> vconsole.conf"
    "DDCCI Sürücü Kurulumu" "DDCCI ayarları"
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Yapılandırma Menüsü" --default-item "${nextitem}" --cancel-button "Geri" --menu "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" = "0" ]]; then
    case ${sel} in
    "Dotfile'lar")
      dotfilesmenu
      nextitem="Takas Dosyası Yapılandırması"
      ;;
    "Takas Dosyası Yapılandırması")
      if confirm "\nHazırda bekletme (hibernation) için çekirdek modülünü uygulamak istiyor musunuz? \nSadece systemd-boot önyükleyicisi için geçerlidir!!! \n " "" 10 60; then
        swap_file_config
      else
        message "\nHerhangi bir değişiklik yapılmadı!" "" 6 40
      fi
      nextitem="Ağ Yapılandırması"
      ;;
    "Ağ Yapılandırması")
      network_config
      nextitem="TR klavye desteği"
      ;;
    "TR klavye desteği")
      clear
      echo "sudo localectl set-x11-keymap tr pc105"
      sudo localectl set-x11-keymap tr pc105
      pressanykey
      nextitem="DDCCI Sürücü Kurulumu"
      ;;
    "DDCCI Sürücü Kurulumu")
      if confirm "\nDDCCI sürücüsü için gerekli ayarları uygulamak istiyor musunuz? \n " "" 10 65; then
        clear
        ddci-setup
      fi
      ;;
    esac

    configmenu "${nextitem}"
  fi
}

# Takas Dosyası Hazırda Bekletme Ayarları
swap_file_config() {
  clear

  # Takas dosyasının varlığını ve aktifliğini kontrol et
  if [[ ! -f /swapfile ]] || ! swapon --show=name | grep -q "/swapfile"; then
    echo "Hata: /swapfile bulunamadı veya aktif değil. Önce oluşturun ve etkinleştirin."
    return 1
  fi

  # Gerekli araçların kurulu olduğunu doğrula
  if ! command -v filefrag >/dev/null; then
    echo "Gerekli araçlar kuruluyor (e2fsprogs)..."
    sudo pacman -S e2fsprogs --noconfirm || return 1
  fi

  # Takas dosyası detaylarını güvenli bir şekilde al
  local swapfileuuid swapfileoffset
  swapfileuuid=$(findmnt -no UUID -T /swapfile 2>/dev/null) || {
    echo "Hata: Takas dosyası UUID'si alınamadı"
    return 1
  }
  swapfileoffset=$(sudo filefrag -v /swapfile | awk '$1=="0:" {print $4}' | tr -d '.') || {
    echo "Hata: Takas dosyası ofseti alınamadı"
    return 1
  }

  # Alınan değerleri doğrula
  if [[ -z "$swapfileuuid" || -z "$swapfileoffset" ]]; then
    echo "Hata: Takas dosyası parametreleri belirlenemedi"
    return 1
  fi

  # Çekirdek komut satırı yapılandırması
  local presentkernelcmdline newkernelcmdline
  presentkernelcmdline=$(cat /etc/kernel/cmdline 2>/dev/null)
  local resume_params="resume=UUID=$swapfileuuid resume_offset=$swapfileoffset"

  if ! grep -Pq "resume=UUID=\S+\s+resume_offset=\d+" <<<"$presentkernelcmdline"; then
    # Varsa mevcut bekleme parametrelerini temizle
    newkernelcmdline=$(sed -E 's/\s*resume=[^ ]+//g;s/\s*resume_offset=[^ ]+//g' <<<"$presentkernelcmdline")
    newkernelcmdline="$newkernelcmdline $resume_params"
    echo "$newkernelcmdline" | sudo tee /etc/kernel/cmdline >/dev/null
    sudo mkinitcpio -P
  else
    message "Hazırda bekletme parametreleri zaten cmdline'da mevcut:\n$(grep -Po 'resume=.*?(\s|$)' <<<"$presentkernelcmdline")"
  fi

  # mkinitcpio kanca (hook) yapılandırması
  local mkinitfile="/etc/mkinitcpio.conf"
  if ! grep -q '^HOOKS=.*\bresume\b' "$mkinitfile"; then
    # 'resume' kancasını 'fsck' kancasından önce ekle (veya varsa 'filesystems' kancasından sonra ekleyin)
    sudo sed -i '/^HOOKS=(/ s/\<fsck\>/resume &/' "$mkinitfile"
    sudo mkinitcpio -P
  else
    echo "Resume kancası zaten mkinitcpio.conf'ta mevcut"
  fi

  # Son doğrulama
  if grep -q "$resume_params" /etc/kernel/cmdline &&
    grep -q '^HOOKS=.*\bresume\b' "$mkinitfile"; then
    message "Takas dosyası hazırda bekletme için başarıyla yapılandırıldı!\n\nDeğişikliklerin uygulanması için yeniden başlatmanız gerekiyor."
  else
    echo "Hata: Yapılandırma başarısız olmuş olabilir. Lütfen manuel olarak doğrulayın:"
    echo "- /etc/kernel/cmdline içeriği:"
    cat /etc/kernel/cmdline
    echo -e "\n- mkinitcpio kancaları:"
    grep '^HOOKS=' "$mkinitfile"
    return 1
  fi

  pressanykey
}

# Ağ Paylaşım Yapılandırması
network_config() {
  local options=(
    "samba" "Windows/Linux/macOS Dosya Paylaşımı" on
    "avahi" "Ağ Hizmetleri Keşfi (mDNS/Zeroconf)" on
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Ağ Yapılandırması :" --cancel-button "Geri" --checklist "" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq "0" ]]; then
    local pkg="" aurpkg=""
    for item in $sel; do
      item=$(echo "$item" | tr -d '"')
      case $item in
      # "") aurpkg="$aurpkg $item" ;;
      *) pkg="$pkg $item" ;;
      esac
    done

    instpkg "$pkg" "$aurpkg"

    if pacman -Qq samba >/dev/null; then
      clear

      # Samba yapılandırmasını yedekle
      if [[ -f /etc/samba/smb.conf ]]; then
        sudo cp /etc/samba/smb.conf /etc/samba/smb.conf.bak
      fi

      # Daha güvenli varsayılanlarla Samba yapılandırması oluştur
      sudo mkdir -p /etc/samba # Dizin varlığını sağla
      printf "%s\n" \
        "[global]" \
        "workgroup = WORKGROUP" \
        "usershare path = /var/lib/samba/usershares" \
        "usershare max shares = 100" \
        "usershare allow guests = no" \
        "server string = Samba Server" \
        "client min protocol = SMB3" \
        "server min protocol = SMB3" \
        "server role = standalone server" \
        "log file = /var/log/samba/%%m.log" \
        "max log size = 1000" \
        "vfs objects = fruit streams_xattr" \
        "fruit:metadata = stream" \
        "fruit:model = Macintosh" | sudo tee /etc/samba/smb.conf >/dev/null

      # usershare dizini oluştur
      sudo mkdir -p /var/lib/samba/usershares
      sudo chown root:sambashare /var/lib/samba/usershares
      sudo chmod 1770 /var/lib/samba/usershares

      # sambashare grubunu yapılandır
      if ! getent group sambashare >/dev/null; then
        sudo groupadd -r sambashare
      fi
      sudo gpasswd -a "$localuser" sambashare

      # Servisleri yeniden başlat
      sudo systemctl restart smb.service nmb.service

      # Etkileşimli olarak Samba parolası belirle
      echo "Samba kullanıcısı $localuser için bir parola belirleyin:"
      sudo smbpasswd -a "$localuser"

      # Ana servisleri etkinleştir
      serviceenable smb
      serviceenable nmb
    fi

    # Avahi'yi koşullu olarak etkinleştir
    if [[ "$sel" == *"avahi"* ]] && pacman -Qq avahi >/dev/null; then
      serviceenable avahi-daemon.service
    fi

    # firewalld kullanılıyorsa
    if command -v firewall-cmd >/dev/null; then
      sudo firewall-cmd --permanent --add-service=samba
      sudo firewall-cmd --reload
    fi

    echo "Samba yapılandırması tamamlandı. Değişikliklerin uygulanması için sistemi yeniden başlatın veya servisleri yeniden başlatın."
    pressanykey
  fi
}

# Dotfile'lar Alt Menüsü
dotfilesmenu() {
  local nextitem="${1:-.}"
  local options=(
    "Dotfile'ları Yönet" "Konfigürasyonları Kopyala/Sembolik Bağla"
    "Neovim" "Neovim dotfile'larını ayarla"
    "Sddm Tema" "Sugar-Candy veya başka bir SDDM temasını kur"
    "Duvar Kağıtları" "Duvar kağıtlarını kur"
    "KMSCON" "Sanal Konsol yapılandırmasını kur"
    "bat önbelleğini oluştur" "cat muadili"
    "Neovim dotfile'larını kaldır" "nvim yapılandırmasını tamamen sil"
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Dotfile'lar :" --default-item "${nextitem}" --cancel-button "Geri" --menu "" 0 60 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    case ${sel} in
    "Dotfile'ları Yönet")
      manage_dotfiles
      nextitem="Neovim"
      ;;
    "Neovim")
      neovim_dot
      nextitem="Sddm Tema"
      ;;
    "Sddm Tema")
      install_sddmtheme
      nextitem="Duvar Kağıtları"
      ;;
    "Duvar Kağıtları")
      install_wallpapers
      nextitem="KMSCON"
      ;;
    "KMSCON")
      install_kmscon
      nextitem="bat önbelleğini oluştur"
      ;;
    "bat önbelleğini oluştur")
      # Bat önbellek oluşturma
      if command -v bat >/dev/null; then
        bat cache --build >/dev/null
      fi
      nextitem="Neovim dotfile'larını kaldır"
      ;;
    "Neovim dotfile'larını kaldır")
      if confirm "\nnvim dotfile'larını kaldırmak istiyor musunuz?" "" 8 60; then
        rm -rf /home/$localuser/.config/nvim
        rm -rf /home/$localuser/.local/share/nvim
        rm -rf /home/$localuser/.cache/nvim
        if [[ "$?" -eq 0 ]]; then
          message "\nNvim dotfile'ları tamamen kaldırıldı." "" 8 60
        fi
      fi
      nextitem="Neovim dotfile'larını kaldır"
      ;;
    esac
    dotfilesmenu "${nextitem}"
  fi
}

# Dotfile'ları Kopyalama ve Sembolik Bağlama
manage_dotfiles() {
  # --------------------------
  # Yardımcı Fonksiyonlar
  # --------------------------

  # Yönetilen sembolik bağların geçerli kaynaklara işaret edip etmediğini doğrular.
  # $1: hedef ana dizin (örn: $HOME/.config)
  # $2..n: yönetilen öğeler dizisi
  validate_symlinks() {
    local target_base="$1"
    local items=("${@:2}")
    local broken_links=()
    local exit_code=0

    echo "Yönetilen sembolik bağlar doğrulanıyor: $target_base"

    for item in "${items[@]}"; do
      local target="${target_base}/${item}"

      # Hedefin bir sembolik bağ olup olmadığını kontrol et
      if [[ -L "$target" ]]; then
        # Sembolik bağın hedefinin varlığını kontrol et
        if [[ ! -e "$(readlink -f "$target")" ]]; then
          broken_links+=("$target → $(readlink "$target")")
          exit_code=1
        fi
      else
        echo "Uyarı: $item bir sembolik bağ değil, kaynak varlığı doğrulanamıyor." >&2
        exit_code=1
      fi
    done

    if [[ ${#broken_links[@]} -gt 0 ]]; then
      echo -e "\nBozuk sembolik bağlar bulundu:"
      printf '  - %s\n' "${broken_links[@]}"
    else
      echo -e "\nTüm yönetilen sembolik bağlar geçerli"
    fi

    return $exit_code
  }

  # Kesinti durumunda bozuk durumu önlemek için sembolik bağı atomik olarak oluşturur.
  # $1: kaynak dosya/dizin
  # $2: hedef yol
  atomic_symlink() {
    local source="$1"
    local target="$2"
    local temp_target="${target}.newlink"

    # Sembolik bağı geçici bir hedefe oluştur
    if ln -sfn "$source" "$temp_target"; then
      # Eski hedefi (varsa) yeni bağ ile atomik olarak değiştir
      if mv -f "$temp_target" "$target"; then
        echo "Oluşturuldu: $target → $source"
        return 0
      fi
    fi

    echo "Sembolik bağ oluşturulamadı: $target" >&2
    rm -f "$temp_target" # Başarısızlıkta geçici dosyayı temizle
    return 1
  }

  # --------------------------
  # Ana Fonksiyon Mantığı
  # --------------------------

  isrsync                           # rsyn'i kontrol etmeli/kurmalı
  clone_repo "dotfiles" || return 1 # Dotfile deposunu klonlamalı

  local required_dirs=("config" "home")
  for dir in "${required_dirs[@]}"; do
    if [[ ! -d "${script_dir}/dotfiles/${dir}" ]]; then
      echo "Hata: ${script_dir}/dotfiles dizininde gerekli '${dir}' dizini eksik"
      pressanykey
      return 1
    fi
  done

  # --------------------------
  # Kurulum İşleyici
  # --------------------------

  # Öğe seçimi için dialog kontrol listesini görüntüler.
  # $1: Başlık
  # $2: Taranacak Yol
  show_selection_dialog() {
    local title="$1"
    local path="$2"

    local options=()
    # Boşluk/özel karakter içeren dosya adlarını güvenli bir şekilde işlemek için find ve read kullanılır.
    while IFS= read -r -d $'\0' item; do
      local clean_name="${item##*/}"
      options+=("$clean_name" "" off)
    done < <(find "$path" -mindepth 1 -maxdepth 1 \( -type d -o -type f \) -print0 | sort -zV)

    [[ ${#options[@]} -eq 0 ]] && return 1

    local sel
    sel=$(dialog --backtitle "$apptitle" \
      --title "$title" \
      --cancel-button "Geri" \
      --checklist "Senkronize edilecek öğeleri seçin:" \
      0 0 0 \
      "${options[@]}" \
      3>&1 1>&2 2>&3)

    echo "$sel"
  }

  # Kurulum sürecini yönetir (Kopyala, Sembolik Bağla veya Doğrula).
  # $1: bölüm adı (örn: "config" veya "home")
  # $2: hedef ana yol (örn: $HOME/.config veya $HOME)
  process_installation() {
    local section="$1"
    local target_base="$2"
    shift 2

    # Birleşik yedekleme yapılandırması
    local BACKUP_ROOT="$(xdg-user-dir DOCUMENTS)/dotfiles_yedek"
    local TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    local BACKUP_DIR="$BACKUP_ROOT/$TIMESTAMP"
    mkdir -p "$BACKUP_DIR"

    # Seçim diyalogu
    local sel=$(show_selection_dialog "Seçilen ${section^} Dosyaları" "${script_dir}/dotfiles/${section}") || return 1
    [[ -z "$sel" ]] && return 0

    # --- BAŞLANGIÇ: Sağlam seçim ayrıştırma (Çoklu seçim sorununu çözer) ---
    local selected_items=()
    local items_with_quotes=()
    local IFS_TEMP=$IFS

    # 1. Tırnaklı dialog çıktısını ayırmak için boşluk (space) kullanılır.
    IFS=' '
    items_with_quotes=($sel)
    IFS=$IFS_TEMP # IFS'i hemen geri yükle

    # 2. Her bir öğenin etrafındaki tırnakları temizle
    for item in "${items_with_quotes[@]}"; do
      local clean_item
      # Baştaki (^) ve sondaki ($) tırnakları kaldıran sed komutu
      clean_item=$(echo "$item" | sed 's/^"//; s/"$//')
      selected_items+=("$clean_item")
    done
    # --- SON: Sağlam seçim ayrıştırma ---

    # Eylem seçimi
    local response=$(dialog --backtitle "$apptitle" \
      --title "Onay" \
      --menu "Senkronizasyon yöntemini seçin:" \
      0 0 0 \
      "Kopyala" "Yedeklemelerle doğrudan kopyalama" \
      "Sembolik Bağla" "Sembolik bağlantılar oluştur" \
      "Doğrula" "Mevcut bağlantıları kontrol et" \
      "İptal" "İşlemi durdur" \
      3>&1 1>&2 2>&3) || return 1

    case $response in
    "Kopyala")
      clear
      echo -e "Değişikliklerin önizlemesi:\n"

      # Sağlam seçili öğeler dizisini kullan
      for item in "${selected_items[@]}"; do
        local full_source="${script_dir}/dotfiles/${section}/${item}"
        local target="${target_base}/${item}"
        local source # rsync kaynak yolu, dosya veya dizine göre ayarlanır

        # KONTROL: Kaynak yolunu rsync için türe göre ayarla (dosya veya dizin)
        if [[ -d "$full_source" ]]; then
          # Eğer kaynak bir dizin ise, *içeriği* kopyalamak için '/' ekle
          source="${full_source}/"
        else
          # Eğer kaynak bir dosya ise, yolu olduğu gibi kullan
          source="$full_source"
        fi

        echo -e "─── $item ───"
        # Önizleme için --dry-run
        rsync -avh --dry-run --backup --backup-dir="$BACKUP_DIR" \
          "$source" "$target" --delete
        echo
      done
      pressanykey

      if confirm "Değişiklikleri uygula? Yedekleme konumu: $BACKUP_DIR"; then
        clear
        for item in "${selected_items[@]}"; do
          local full_source="${script_dir}/dotfiles/${section}/${item}"
          local target="${target_base}/${item}"
          local source

          # KONTROL: Kaynak yolunu rsync için türe göre ayarla
          if [[ -d "$full_source" ]]; then
            source="${full_source}/"
          else
            source="$full_source"
          fi

          if [[ -L "$target" ]]; then
            echo "Mevcut sembolik bağ kaldırılıyor: $target"
            rm -f "$target"
          fi

          echo -e "Kuruluyor: $item"
          # Gerçek rsync çalıştırması
          rsync -avh --backup --backup-dir="$BACKUP_DIR" \
            "$source" "$target" --delete
        done
        pressanykey
      fi
      ;;

    "Sembolik Bağla")
      local dotfiles_root="${HOME}/.dotfiles"
      local managed_items=()

      # Sembolik bağ oluşturmadan önce dotfiles deposunu yedekleyerek senkronize et
      if [[ ! -d "${dotfiles_root}" ]]; then
        echo "Dotfiles deposu başlatılıyor..."
        # Bölüm dizini içeriklerini dotfiles kök dizinine senkronize et.
        if ! rsync -a --backup --backup-dir="${BACKUP_DIR}" \
          "${script_dir}/dotfiles/" "${dotfiles_root}/"; then
          echo "Hata: Dotfiles deposu başlatılamadı" >&2
          return 1
        fi
      else
        echo "Mevcut dotfiles deposu kullanılıyor: ${dotfiles_root}"
      fi

      clear
      # Sağlam seçili öğeler dizisini kullan
      for item in "${selected_items[@]}"; do
        managed_items+=("$item")
        local source="$dotfiles_root/${section}/${item}"
        local target="${target_base}/${item}"

        # Mevcut hedefi varsa yedekle
        if [[ -e "$target" ]]; then
          echo "Yedekleniyor: $target"
          mv -f "$target" "$BACKUP_DIR"
        fi

        mkdir -p "$(dirname "$target")"
        atomic_symlink "$source" "$target"
      done

      # Yalnızca yönetilen öğeleri doğrula
      if validate_symlinks "$target_base" "${managed_items[@]}"; then
        echo "Başarılı - tüm yönetilen bağlantılar geçerli"
      else
        read -p "Sorunlar bulundu. Yine de devam edilsin mi? [e/H] " -n 1
        [[ $REPLY =~ ^[Ee]$ ]] || return 1
      fi
      pressanykey
      ;;

    "Doğrula")
      local managed_items=()
      # Sağlam seçili öğeler dizisini kullan
      for item in "${selected_items[@]}"; do
        managed_items+=("$item")
      done

      if validate_symlinks "$target_base" "${managed_items[@]}"; then
        echo "Başarılı - tüm yönetilen bağlantılar geçerli"
      else
        echo "Uyarı: Yönetilen bağlantılarda sorunlar tespit edildi" >&2
      fi
      pressanykey
      ;;

    *) return 1 ;;
    esac
  }

  # --------------------------
  # Ana Yürütme Akışı
  # --------------------------
  while true; do
    local choice=$(dialog --backtitle "$apptitle" \
      --title "Ana Dotfiles Menüsü" \
      --menu "Yapılandırma bölümünü seçin:" \
      0 0 0 \
      "Config" "~/.config dizini ayarları" \
      "Home" "Ev dizini dotfile'ları" \
      "Çıkış" "Ana menüye dön" \
      3>&1 1>&2 2>&3) || return 1

    case $choice in
    "Config")
      process_installation "config" "$HOME/.config"
      ;;
    "Home")
      process_installation "home" "$HOME"
      ;;
    "Çıkış")
      return 0
      ;;
    esac
  done
}

neovim_dot() {
  if confirm "\nNeovim dotfiles $localuser için kurulsun mu?" "" 8 60; then
    clear

    clone_repo "nvim" /home/"$localuser"/.config/nvim
    message "\nNeovim dotfiles kuruldu." "" 8 40

    if confirm "\nAyrıca root kullanıcısı için de NeoVim dotfiles kurulsun mu?" "" 8 60; then
      sudo mkdir -p /root/.config/nvim
      sudo ln -sf /home/$localuser/.config/nvim/* /root/.config/nvim
      message "\nNvim dotfiles root için kopyalandı." "" 8 40
    fi
  fi
}

install_sddmtheme() {
  if confirm "\nSugar-Candy temasını kurmak ister misiniz?" "" 8 60; then

    isrsync
    clone_repo "dotfiles" || return 1

    local sddmconf_dir="/etc/sddm.conf.d"
    local sugarcandy_dir="/usr/share/sddm/themes/sugar-candy"
    local cloned_dotfiles_dir="$script_dir/dotfiles"

    if command -v sddm &>/dev/null; then
      sudo mkdir -p "$sddmconf_dir"
      sudo mkdir -p "$sugarcandy_dir"

      printf "%s\n" "[Theme]" "Current=sugar-candy" | sudo tee "$sddmconf_dir/10-theme.conf" >/dev/null

      if [[ -f "$cloned_dotfiles_dir/sddm/sddm.conf" ]]; then
        sudo rsync -avh "$cloned_dotfiles_dir/sddm/sddm.conf" "$sddmconf_dir/sddm.conf" --delete
      else
        message "\nSDDM konfigurasyon dosyası klonlanan repoda bulunamadı!" "Error" 8 60
        return 1
      fi

      local tarball_path="$cloned_dotfiles_dir/sddm/sugar-candy/sugar-candy.tar.gz"
      if [[ -f "$tarball_path" ]]; then
        sudo tar -xzvf "$tarball_path" -C "/usr/share/sddm/themes"
        message "\nTema kuruldu." "Success" 8 60
      else
        message "\nTema kurulamadı!" "Error" 8 60
        return 1
      fi
    else
      message "SDDM yüklü değil. Lütfen ilk önce sddm kurun." "Error" 10 60
      return 1
    fi
  fi
}

install_wallpapers() {
  # Variables
  local wallpaperdir="$(xdg-user-dir PICTURES)"
  local clone_dir="$script_dir/Wallpaper"

  if confirm "\nDuvar kağıtlarını bu konuma kopyalamak ister misiniz:\n$wallpaperdir?" "Duvar kağıtları Yükleme" 10 60; then
    # Clone repository to temporary directory
    if ! clone_repo "Wallpaper"; then
      message "Duvar kağıtları indirilemedi!" "Error" 8 60
      return 1
    fi

    # Show changes preview
    clear
    echo "Değişiklik önizlemesi:"
    rsync -avh --dry-run --itemize-changes "$clone_dir/" "$wallpaperdir" --delete

    if confirm "\nDuvar kağıtları değişikleri uygulansın mı?\nBuradan: $clone_dir\nBuraya: $wallpaperdir" "Onaylama" 12 70; then
      clear
      echo -e "\nKopyalanıyor..."
      if rsync -avh --progress "$clone_dir/" "$wallpaperdir" --delete; then
        message "Başarıyla buraya kopyalandı:\n$wallpaperdir" "Success" 8 65
      else
        message "Kopyalama başarısız!\nÇıkış kodu: $?" "Error" 8 60
        return 1
      fi
    else
      message "İptal edildi." "Canceled" 8 50
    fi
  fi
}

install_kmscon() {
  local config_file="/etc/kmscon/kmscon.conf"
  local font_setting="JetBrainsMono Nerd Font Mono"
  local tty_input

  if confirm "KMSCON kurmak ve ayarlamak istermisiniz?" "" 6 50; then
    clear
    # 1. KMSCON Kurulumu
    echo "KMSCON paketleri kuruluyor..."
    # instpkg fonksiyonunun başarılı olduğundan emin olun.
    instpkg "" "kmscon" || {
      echo "Hata: kmscon kurulumu başarısız oldu." >&2
      return 1
    }

    # Dizin oluşturma
    sudo mkdir -p /etc/kmscon || {
      echo "Hata: /etc/kmscon dizini oluşturulamadı." >&2
      return 1
    }

    # 2. TTY Numarası Alma
    tty_input=$(dialog --backtitle "${apptitle}" --title "KMSCON'u hangi TTY için ayarlamak istersiniz?" --inputbox "Lütfen 3 ile 6 arasında bir TTY numarası girin:" 8 70 "5" 3>&1 1>&2 2>&3)

    # Kullanıcı iptali kontrolü (dialog exit code 0 değilse)
    if [ "$?" -ne 0 ]; then
      echo "KMSCON kurulumu kullanıcı tarafından iptal edildi." >&2
      return 1
    fi

    # 3. KMSCON Yapılandırma Dosyasını Yazma (/etc/kmscon/kmscon.conf)
    echo "KMSCON global yapılandırma dosyası yazılıyor: $config_file"

    # Yapılandırma içeriğini yazma
    printf "%s\n" \
      "font-name=$font_setting" \
      "font-size=14" \
      "font-dpi=96" | sudo tee "$config_file" >/dev/null

    # tee komutunun başarı kontrolü
    if [ "$?" -ne 0 ]; then
      echo "Hata: Yapılandırma dosyası $config_file yazılamadı." >&2
      return 1
    fi

    # 4. systemd Hizmetlerini Ayarlama

    # Mevcut getty hizmetini devre dışı bırak
    echo "tty${tty_input} için mevcut getty hizmeti devre dışı bırakılıyor."
    servicedisable getty@tty$tty_input.service || echo "Uyarı: getty hizmeti devre dışı bırakılamadı." >&2

    # KMSCON hizmetini aktif et
    echo "KMSCON hizmeti tty${tty_input} için aktif ediliyor."
    serviceenable kmsconvt@tty$tty_input.service || {
      echo "Hata: kmsconvt@tty$tty_input.service etkinleştirilemedi. Birim adını kontrol edin." >&2
      return 1
    }

    # 5. Klavye Haritasını Ayarlama
    echo "Klavye haritası 'tr' olarak ayarlanıyor."
    # --no-ask-password bayrağını kaldırdım. Güvenli sudo/localectl kullanın.
    sudo localectl set-x11-keymap tr pc105
    clear
    echo "KMSCON kurulumu tty${tty_input} için başarıyla tamamlandı."

  else
    clear
    echo "KMSCON kurulumu atlandı."
  fi
  pressanykey
  return 0
}

shutdownmenu() {
  local options=(
    "Yeniden başlat" ""
    "Kapat" ""
  )

  local sel
  sel=$(dialog --backtitle "$apptitle" --title "Kapatma Menüsü" --cancel-button "Geri" --menu "Seçim yapın:" 0 0 0 "${options[@]}" 3>&1 1>&2 2>&3)

  if [[ "$?" -eq 0 ]]; then
    case $sel in
    "Yeniden başlat")
      if confirm "Sistemi şimdi yeniden başlatmak istediğinizden emin misiniz?" "" 6 30; then
        reboot
      fi
      ;;
    "Kapat")
      if confirm "Sistemi şimdi kapatmak istediğinizden emin misiniz?" "" 6 30; then
        poweroff
      fi
      ;;
    esac
  fi
}

# ==========================================================
# Gerekli Bileşenleri ve Global Kapsamı Yükle
# ==========================================================
genelkapsamiyukle() {
  # Açık dizi ile packet bağımlılıkları
  local packages=()
  packages=(
    dialog
    neovim
    xdg-user-dirs
    tree
  )

  # Eksik bağımlılıkları kur
  local missing_pkgs=()
  for pkg in "${packages[@]}"; do
    # -Qe: Sadece kurulu olanları ve açıkça istenenleri listele
    if ! pacman -Qe "${pkg}" &>/dev/null; then
      missing_pkgs+=("$pkg")
    fi
  done

  if [[ ${#missing_pkgs[@]} -gt 0 ]]; then
    echo "Eksik bağımlılıklar kuruluyor: ${missing_pkgs[*]}"
    # --needed: Yalnızca henüz kurulu olmayanları kur
    sudo pacman -S --needed --noconfirm "${missing_pkgs[@]}" || {
      echo "Hata: Bağımlılıklar kurulamadı!" >&2
      return 1
    }
  fi

  # --------------------------
  # XDG Kullanıcı Dizinleri Yapılandırması (Öneri ile Güncellenmiştir)
  # --------------------------
  if pacman -Qq xdg-user-dirs >/dev/null; then
    # Doğrulama: İNDİRİLENLER dizininin varlığını kontrol et
    if [[ -d "$(xdg-user-dir DOWNLOAD)" ]]; then
      echo "XDG Dizinleri başarıyla oluşturuldu/güncellendi."
    else
      echo "XDG Kullanıcı Dizinleri kontrol ediliyor ve güncelleniyor..."

      # Güvenilirlik için daima --force bayrağını kullanın
      xdg-user-dirs-update
      xdg-user-dirs-update --force
    fi
  fi

  # --------------------------
  # Ortam Yapılandırması
  # --------------------------
  local color_config="colors"
  # DIALOGRC dosyasını oluştur ve renk ayarlarını yaz
  printf "%s\n" \
    "use_shadow = OFF" \
    "title_color = (BLACK,WHITE,OFF)" \
    "button_label_active_color = (WHITE,BLUE,ON)" \
    "button_label_inactive_color = (BLACK,WHITE,OFF)" \
    "tag_color = (BLACK,WHITE,OFF)" \
    "tag_selected_color = (WHITE,BLUE,ON)" \
    "tag_key_color = (BLACK,WHITE,OFF)" \
    "tag_key_selected_color = (WHITE,BLUE,ON)" \
    "check_color = tag_color" \
    "check_selected_color = tag_selected_color" >"${color_config}"

  export DIALOGRC="${color_config}" # dialog için renk dosyasını ayarla
  export EDITOR=nvim                # Varsayılan düzenleyiciyi ayarla

  # Global değişkenler
  declare -g apptitle="Arch Linux DE & Uygulama Kurulumu"
  declare -g localuser="$(whoami)"
  declare -g script_dir="$(dirname "$(realpath "$0")")"
}

# ==========================================================
# Kurulum Temizliği
# ==========================================================
kurulum_temizle() {
  # Çıkış durumuna bakılmaksızın her zaman temizle
  local to_remove=(
    "dotfiles"
    "Wallpaper"
    "colors"
  )

  clear
  echo "Kurulum dosyaları temizleniyor..."
  for item in "${to_remove[@]}"; do
    local path="${script_dir:?}/$item" # Güvenli yol
    if [[ -d "$path" ]]; then
      rm -rf "${path}"
    elif [[ -f "$path" ]]; then
      rm -f "${path}"
    fi
  done
}

# ==========================================================
# Betiği Başlat
# ==========================================================
baslat() {
  # Root olarak çalıştırılmasını engelle
  if [[ $(id -u) -eq 0 ]]; then
    echo "Hata: Bu betik root (yönetici) olarak çalıştırılmamalıdır!" >&2
    return 1
  fi

  # if [[ ! -d "$(xdg-user-dir DOWNLOAD)" ]]; then
  #   echo "Hata: XDG kullanıcı dosyaları olmadan bu betik çalışmaz. \nxdg-user-dirs paketini yükleyin. \nxdg-user-dirs-update komutunu çalıştırın! "
  #   return 1
  # fi

  if [[ "$1" == "fonksiyonlar" ]]; then
    # FONKSİYON LİSTELEME VE SÜTUNLARA AYIRMA
    grep '() {' "$(realpath "$0")" |
      grep -vE '^\s*#' |
      grep -v 'realpath "$0"' |
      sed 's/().*//' |
      column # Çıktıyı terminal genişliğine göre sütunlara ayırır.
    exit 0
  fi

  if [[ -z "$1" ]]; then
    echo "Arch Linux Kurulumu başlatılıyor..."
    genelkapsamiyukle || return 1
    mainmenu
  else
    echo "Arch Linux Kurulumu - Fonksiyon Modu"
    # Komut satırı argümanı olarak bir fonksiyon adı verilmişse
    if declare -f "$1" >/dev/null; then
      genelkapsamiyukle || return 1
      "$@" # Uygun argüman işleme ile fonksiyonu çalıştır
    else
      echo "Hata: Fonksiyon '$1' bulunamadı" >&2
      return 1
    fi
  fi

  kurulum_temizle
}

baslat "$@"
